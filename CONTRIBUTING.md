CONTRIBUTING to gitlab-i18n-patch
=================================

パッチを作成する際の方法に関するメモです。  
CONTRIBUTINGとしていますが、備忘録程度のものです。  
もし賛同して修正してくださる方がいれば、参考にしてください。

## ベースとするバージョンについて

基本的に、[GitLab-CE の Omnibus Package](https://www.gitlab.com/downloads/) が提供されているバージョンを対象としています。  

また、作成されたパッチを適用できる GitLabのバージョンについては、  
パッチであるが故に、行番号がずれると適用できないため  
対象とした特定のバージョンのみでしか使えません。
例えば、 v6.6.4向けのパッチはv6.6.5には正常に適用できません。

## 通常のパッチ更新方法について

通常の更新(GitLabのバージョンアップを伴わない更新)では、
`gitlab-rails` (変更なし)を `gitlab-rails.bk`というバックアップとしてコピーしておき、
`gitlab-rails`に対して日本語化の修正をしていきます。  

修正後は、 `make_patch.sh`をGitLabのインストールされたマシン内で実行すると
`gitlab-rails`と `gitlab-rails.bk`の差分を `app_ja.patch`ファイルとして取得します。
差分を取得した後で `gitlab-rails` を削除して `gitlab-rails.bk`から再びコピーして復元し、
取ったばかりの差分を適用してみて正常に適用できるかどうかを確認します。

Vagrantの仮想マシン内で以下を実行します。

    sudo -E /vagrant/lib/make_patch.sh

## バージョンアップについて

GitLab-CEの新バージョンに日本語訳を適用したい場合、  
GitLab-CEのリポジトリを使って旧バージョンのコードに作成済みのパッチを反映し、  
新バージョンをマージすることで新バージョンのパッチを作成します。
このプロジェクト用にメンテナンスしている[Forkはこちら](https://github.com/ksoichiro/gitlabhq)。

1. GitLab-CE のリポジトリをクローンして、
   ベースとする日本語訳バージョン(`v6.6.4`など)に対応する
   GitLab-CEのタグ(`v6.6.4`など)をチェックアウトします。  
   ここからブランチを作成し(`v6.6.4_ja`など)、日本語訳パッチを適用してローカルでコミットします。
2. コミットした位置から、新日本語訳バージョンのブランチ(`v6.7.2_ja`など)を作成します。
3. 2.のブランチに対して、GitLab-CEの新バージョン(`v6.7.2`など)のタグをマージします。
   日本語訳のために修正した行、もしくはその付近で修正が入っていた場合、
   その部分がコンフリクトします。  
   このコンフリクトを解消すればほぼ完成です。  
   良い方法ではないですが、元々GitLabが英語のみの構造になっていることもあり力技で訳しています。
4. 新バージョンで追加するべき訳があれば、反映します。
5. 新バージョンタグ(`v6.7.2`など)と新バージョン日本語訳ブランチの差分を `git diff`コマンドで
   取得して `patches/v6.7.2/app_ja.patch`として保存します。
6. [GitLab Omnibus Package](https://www.gitlab.com/downloads/)の新バージョンに対応するURLを調べます。  
   本プロジェクトでは `lib/provision.sh` でURLのフォーマットをバージョン別に作成するように
   していますが、URLのフォーマットが変更になった場合は、それに対応するコードを追加します。
7. 新しいバージョンを`Vagrantfile`に追記し、`vagrant up v681` などとして起動します。  
8. `/opt/gitlab/embedded/service`以下に `gitlab-rails`と `gitlab-rails.bk`が
   あり、 `gitlab-rails` には古い翻訳が反映され動かなくなっているはずです。  
   `gitlab-ctl stop` した上で、5.の差分を手動で反映してみます。  
   実行時にパッチ適用失敗したメッセージが出なければ成功です。
   失敗した場合は、拡張子 `.rej`のファイルが出力されているので
   内容を確認してパッチを作り直します。
9. パッチが作成できたら、動作確認をした上で `Vagrantfile`とともにコミットします。

## 動作確認について

GitLabには様々なインストール方法があります。

1. 物理マシンなど、まっさらな環境から各種コンポーネントをインストールしていく
2. GitLabの公式CookbookでVagrant上にインストールする
3. GitLab Omnibus Packageをインストールする

最後の GitLab Omnibus Package が非常にお手軽です。  
gitlab-i18n-patchでは`Vagrantfile`を用意しており、GitLab Omnibus Package のURLを
設定して実行すればパッチ適用までを `vagrant up`だけでできるようになっています。  
この環境で動作確認(主に、表示ができレイアウト崩れや機能を壊すことがないこと)をします。

## 翻訳の追加

検討中のフローのメモです。

[gitlabhqのFork](https://github.com/ksoichiro/gitlabhq)でバージョンアップしてパッチを作成した後、
Vagrantを使って動作確認しつつ翻訳を追加・修正する場合
`gitlabhq`に戻してやると次のバージョンでデグレードする(翻訳が失われる)ことが少なくなります(当然ですが)。

`gitlabhq`の`v7.2.0`から`v7.2.0_ja`ブランチを作成してパッチを作成した後、そのパッチをベースにパッチを修正した場合、
まず`gitlabhq`で`v7.2.0`ブランチに切り替え、そのパッチを適用します。

```
cd /path/to/gitlab-i18n-patch/gitlabhq/
patch -p1 < ../patches/v7.2.0/app_ja.patch
```

ブランチを作成し(`v7.2.0_ja_fix`など)、コミットします。
今度はこれを`v7.2.0_ja`にマージします。

コンフリクトが起きる可能性がありますが、
基本的に相手(`v7.2.0_ja_fix`)の変更を採用するようにマージすれば良いはずです。

もしここで`v7.3.0_ja`のパッチを作成済みだった場合は、
翻訳追加した`v7.2.0_ja`ブランチを`v7.3.0_ja`ブランチにマージします。
この場合もコンフリクトが起きる可能性がありますが、
今度は自分(`v7.3.0_ja`)の変更を採用すべきである可能性が高いです。
これは内容を見ながら判断します。

## その他

### 新しいバージョンへの対応時に役立つコマンド

コンフリクトしたファイルの一覧:

    git status --short | egrep "^UU" | cut -d " " -f 2

コンフリクトしたファイル一覧の先頭を編集:

    vim $(git status --short | egrep "^UU" | cut -d " " -f 2 | head -n 1)

コンフリクトの修正が済んだ先頭ファイルをIndexへ追加:

    git add $(git status --short | egrep "^UU" | cut -d " " -f 2 | head -n 1) 
