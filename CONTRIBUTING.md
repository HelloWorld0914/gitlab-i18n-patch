CONTRIBUTING to gitlab-i18n-patch
=================================

パッチを作成する際の方法に関するメモです。  
CONTRIBUTINGとしていますが、備忘録程度のものです。  
もし賛同して修正してくださる方がいれば、参考にしてください。

## ベースとするバージョンについて

基本的に、[GitLab-CE の Omnibus Package](https://www.gitlab.com/downloads/) が提供されているバージョンを対象としています。  

また、作成されたパッチを適用できる GitLabのバージョンについては、  
パッチであるが故に、行番号がずれると適用できないため  
対象とした特定のバージョンのみでしか使えません。
例えば、 v6.6.4向けのパッチはv6.6.5には正常に適用できません。

## 通常のパッチ更新方法について

通常の更新(GitLabのバージョンアップを伴わない更新)では、
`gitlab-rails` (変更なし)を `gitlab-rails.bk`というバックアップとしてコピーしておき、
`gitlab-rails`に対して日本語化の修正をしていきます。  

修正後は、 `make_patch.sh`をGitLabのインストールされたマシン内で実行すると
`gitlab-rails`と `gitlab-rails.bk`の差分を `app_ja.patch`ファイルとして取得します。
差分を取得した後で `gitlab-rails` を削除して `gitlab-rails.bk`から再びコピーして復元し、
取ったばかりの差分を適用してみて正常に適用できるかどうかを確認します。

## バージョンアップについて

GitLab-CEの新バージョンに日本語訳を適用したい場合、  
GitLab-CEのリポジトリを使って旧バージョンのコードに作成済みのパッチを反映し、  
新バージョンをマージすることで新バージョンのパッチを作成します。

1. GitLab-CE のリポジトリをクローンして、
   ベースとする日本語訳バージョン(v6.6.4など)に対応する
   GitLab-CEのタグ(v6.6.4など)をチェックアウトします。  
   ここからブランチを作成し(v6.6.4_jaなど)、日本語訳パッチを適用してローカルでコミットします。
2. コミットした位置から、新日本語訳バージョンのブランチ(v6.7.2_jaなど)を作成します。
3. 2.のブランチに対して、GitLab-CEの新バージョン(v6.7.2など)のタグをマージします。
   日本語訳のために修正した行、もしくはその付近で修正が入っていた場合、
   その部分がコンフリクトします。  
   このコンフリクトを解消すればほぼ完成です。  
   そして大変な作業です。  
   良い方法ではないですが、元々GitLabが英語のみの構造になっていることもあり力技で訳しています。
4. 新バージョンで追加するべき訳があれば、反映します。
5. 新バージョンタグ(v6.7.2など)と新バージョン日本語訳ブランチの差分を `git diff`コマンドで
   取得します。
6. GitLab Omnibus Packageの新バージョンに対応するURLを調べます。
   これを本プロジェクトの `provision.sh` の所定の箇所に反映し
   `vagrant destroy && vagrant up` します。  
   ( `app_ja.patch`に5.の差分を上書きしても良いです)
7. `/opt/gitlab/embedded/service`以下に `gitlab-rails`と `gitlab-rails.bk`が
   あり、 `gitlab-rails` には古い翻訳が反映され動かなくなっているはずです。  
   `gitlab-ctl stop` した上で、5.の差分を手動で反映してみます。  
   実行時にパッチ適用失敗したメッセージが出なければ成功です。
   失敗した場合は、拡張子 `.rej`のファイルが出力されているので
   内容を確認してパッチを作り直します。
8. パッチが作成できたら、動作確認をした上で `provision.sh`とともにコミットします。

## 動作確認について

GitLabには様々なインストール方法があります。

1. 物理マシンなど、まっさらな環境から各種コンポーネントをインストールしていく
2. GitLabの公式CookbookでVagrant上にインストールする
3. GitLab Omnibus Packageをインストールする

最後の GitLab Omnibus Package が非常にお手軽です。  
gitlab-i18n-patchでは`Vagrantfile`を用意しており、GitLab Omnibus Package のURLを
設定して実行すればパッチ適用までを `vagrant up`だけでできるようになっています。  
この環境で動作確認(主に、表示ができレイアウト崩れや機能を壊すことがないこと)をします。
